<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta
            name="viewport"
            content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>MyChat</title>
    <link rel="stylesheet" href="../static/common.css" />
    <link rel="stylesheet" href="../static/chat.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
            integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="stylesheet" href="../static/scroll.css">
    <style>
      .entry {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        }

      .box {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        width: 30rem;
        height: 30rem;
        background: blue;
        border-radius: 2rem;
        }
      .notice {
        text-align: center;
        color: #005397;
        font-size: 1.2rem;
        }

    </style>
</head>
<body>
<div id="root">
    <div id="chatWrap">
        <div id="chatHeader">
            <button id="back">
                <a href="/">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </button>
            <h1>채팅</h1>

            <button id="more">
                <i class="fas fa-bars"></i>

            </button>
        </div>
        <div id="chatContent" class="container">
            <div class="chat-wrap my-chat-wrap">
                <div class="message chat-box my-chat"><span class="text">테스트 입니다.</span></div>
                <div class="button-bar off my-button-bar flex-off">
                    <button class="btn-item quake" id="quake">🌀</button>
                    <button class="btn-item ta-da" id="tada">🎉</button>
                    <button class="btn-item">💓</button>
                    <button class="btn-item">🌀</button>
                    <button class="btn-item">🌀</button>
                </div>
            </div>
            <div class="chat-wrap ur-chat-wrap">
                <div class="message chat-box ur-chat"><span class="text ">테스트 입니다.</span></div>
                <div class="button-bar off ur-button-bar flex-off">
                    <button class="btn-item quake" id="quake">🌀</button>
                    <button class="btn-item ta-da" id="tada">🎉</button>
                    <button class="btn-item">💓</button>
                    <button class="btn-item">🌀</button>
                    <button class="btn-item">🌀</button>
                </div>
            </div>
            <div class="chat-wrap my-chat-wrap">
                <div class="message chat-box my-chat"><span class="text">테스트 입니다.</span></div>
                <div class="button-bar off my-button-bar flex-off">
                    <button class="btn-item quake" id="quake">🌀</button>
                    <button class="btn-item ta-da" id="tada">🎉</button>
                    <button class="btn-item">💓</button>
                    <button class="btn-item">🌀</button>
                    <button class="btn-item">🌀</button>
                </div>
            </div>
        </div>
        <div id="chatFunc">
            <label for="whisper">
                <select name="select" id="whisper">
                    <option value="귓속말" selected>귓속말</option>
                </select>
            </label>
            <label for="type"></label>
            <input
                    type="text"
                    id="type"
                    name="type"
                    placeholder="메시지를 입력 하세요 ㅎ"
            />
            <button id="enter">전송</button>
        </div>
    </div>
</div>
<div class="entry">
    <div class="box">
        <input type="text" id="nickname" placeholder="Nickname" autofocus />
        <button type="button" onclick="entry();">입장</button>
    </div>
</div>

<script>
  const chat = document.querySelector("#chatContent");
  // const enter = document.querySelector("#enter");
  const urChat = document.querySelector('.ur-chat');
  // const urName = urChat.before;
  // // 대화 상대 이름 서버에서 가져오기
  // function getUserName () {
  //   return 'asd'
  // }
  // // 대화 상대 이름 설정
  // urName.style.content = getUserName();
  //
  // 메시지 전송시 화면 출력
  const addMessage = (e) => {
    if (e.keyCode === 13 || e.type === "click") {
      if (!type.value) {
        alert("메시지를 입력해주세요");
        return;
      } else {
        // io 수신 socket.on send
        const type = document.querySelector("#type");
        const div = document.createElement("div");
        const span = document.createElement("span");
        div.classList.add("my-chat-wrap");
        span.textContent = type.value;
        span.classList.add("chat-box");
        span.classList.add("my-chat");
        div.appendChild(span);
        chat.appendChild(div);
        type.value = "";
        setTimeout(() => {
          chat.scrollTop = chat.scrollHeight;
        }, 0)
      }
    }

  };
  const type = document.querySelector("#type");
  const enter = document.querySelector("#enter");
  enter.addEventListener("click", addMessage);
  type.addEventListener("keydown", addMessage);
  //


</script>

<script>

  // 말풍선 호버할  때 반응 팝업 on/off
  const msg = document.querySelectorAll(".message");
  console.log('msg', msg)
  const chatWrap = document.querySelectorAll(".chat-wrap");
  msg.forEach((item) => {
    // console.log(item);
    item.addEventListener("mouseenter", function (e) {
      // console.log(this);
      e.stopPropagation();
      const btnBar = this.parentNode.querySelector(".button-bar");
      // console.log(btnBar)
      // const btnBar = this.querySelector(".button-bar");
      btnBar.classList.replace("off", "on");
    });
  });
  chatWrap.forEach((item) => {
    item.addEventListener("mouseleave", function (e) {
      e.stopPropagation();
      const btnBar = this.querySelector(".button-bar");
      btnBar.classList.replace("on", "off");
    });
  });
</script>
<script>
  //e.target ** 클릭ㅎ
  // socket io 연결
  let socket = io.connect();
  let myNick;

  socket.on('connect', () => {
    console.log('chat.ejs Connected =.', socket.id)
  })
  socket.on('notice',(msg)=>{
    document
    .querySelector("#chatContent")
    .insertAdjacentHTML("beforeend", `<div class="notice">${msg}</div>`);
  })
  function entry() {
    console.log(document.querySelector("#nickname").value);
    socket.emit("setNick", document.querySelector("#nickname").value);
  }

  socket.on("entry", (nick) => {
    // 1. 내 닉네임 설정
    myNick = nick;
document.querySelector('.entry').remove();
    // // 2. 닉네임 입력창 & 버튼 비활성화
    // document.querySelector("#nickname").disabled = true; // 입력창 비활성화 (클릭 막기)
    // document.querySelector(".entry-box > button").disabled = true; // 버튼 비활성화 (클릭 막기)
    // // 3. div.chat-box 요소 보이기
    // document.querySelector(".chat-box").classList.remove("d-none");
  });

  // 리액션 반응
  const quake = document.querySelectorAll('.quake');
  const tada = document.querySelectorAll('.ta-da');
  const reactObj = {
    quake:[ 'animate__animated', 'animate__shakeX' ],
    tada:[ 'animate__animated', 'animate__tada' ],
  }
  quake.forEach((item) => {
    item.addEventListener('click', function (e) {
      const id = e.target.id;
      const reactID = reactObj[id];
      const target = this.parentNode.parentNode.querySelector('.chat-box')
      // 태그의 고유값 보내기
      target.id = 'id' + Date.now();
      const sid = target.id;
      // console.log(target.id)
      // console.log('this',this)
      // console.log(this.parentNode);
      // console.log('lol',this.parentNode.parentNode.querySelector('.chat-box'));
      const data = {
        reactID:reactID,
        id:sid,
      }
      socket.emit('quake', data);
    })
  })
  // let removeReact;
  socket.on('react', (data) => {
    // console.log(data)
    console.log(data.id)
    console.log(data.first, data.second, data.first)
    const chatBox = document.querySelector('#' + data.id);
    console.log(chatBox)
    // if (removeReact) clearTimeout(removeReact);
    // removeReact = setTimeout(function () {
    //   chatBox.classList.remove(data.second)
    // }, 500)
    // 애니메이션 추가
    chatBox.classList.add(data.first, data.second);
    // 받은 ID 삭제
    chatBox.removeAttribute('id');
  })
  //   채팅창 입장 / 퇴장 안내 문구

  // 채팅방
  socket.emit('setNick', document.querySelector('#nickname').value)
</script>

</body>
</html>
