<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta
            name="viewport"
            content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>MyChat</title>
    <link rel="stylesheet" href="../static/common.css" />
    <link rel="stylesheet" href="../static/chat.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
            integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="stylesheet" href="../static/scroll.css">
    <style>
      .entry {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        }

      .box {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        width: 30rem;
        height: 30rem;
        background: blue;
        border-radius: 2rem;
        }
      .notice {
        text-align: center;
        color: #005397;
        font-size: 1.2rem;
        }

    </style>
</head>
<body>
<div id="root">
    <div id="chatWrap">
        <div id="chatHeader">
            <button id="back">
                <a href="/">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </button>
            <h1>ì±„íŒ…</h1>

            <button id="more">
                <i class="fas fa-bars"></i>

            </button>
        </div>
        <div id="chatContent" class="container">
            <div class="chat-wrap my-chat-wrap">
                <div class="message chat-box my-chat"><span class="text">í…ŒìŠ¤íŠ¸ ì…ë‹ˆë‹¤.</span></div>
                <div class="button-bar off my-button-bar flex-off">
                    <button class="btn-item quake" id="quake">ğŸŒ€</button>
                    <button class="btn-item ta-da" id="tada">ğŸ‰</button>
                    <button class="btn-item">ğŸ’“</button>
                    <button class="btn-item">ğŸŒ€</button>
                    <button class="btn-item">ğŸŒ€</button>
                </div>
            </div>
            <div class="chat-wrap ur-chat-wrap">
                <div class="message chat-box ur-chat"><span class="text ">í…ŒìŠ¤íŠ¸ ì…ë‹ˆë‹¤.</span></div>
                <div class="button-bar off ur-button-bar flex-off">
                    <button class="btn-item quake" id="quake">ğŸŒ€</button>
                    <button class="btn-item ta-da" id="tada">ğŸ‰</button>
                    <button class="btn-item">ğŸ’“</button>
                    <button class="btn-item">ğŸŒ€</button>
                    <button class="btn-item">ğŸŒ€</button>
                </div>
            </div>
            <div class="chat-wrap my-chat-wrap">
                <div class="message chat-box my-chat"><span class="text">í…ŒìŠ¤íŠ¸ ì…ë‹ˆë‹¤.</span></div>
                <div class="button-bar off my-button-bar flex-off">
                    <button class="btn-item quake" id="quake">ğŸŒ€</button>
                    <button class="btn-item ta-da" id="tada">ğŸ‰</button>
                    <button class="btn-item">ğŸ’“</button>
                    <button class="btn-item">ğŸŒ€</button>
                    <button class="btn-item">ğŸŒ€</button>
                </div>
            </div>
        </div>
        <div id="chatFunc">
            <label for="whisper">
                <select name="select" id="whisper">
                    <option value="ê·“ì†ë§" selected>ê·“ì†ë§</option>
                </select>
            </label>
            <label for="type"></label>
            <input
                    type="text"
                    id="type"
                    name="type"
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥ í•˜ì„¸ìš” ã…"
            />
            <button id="enter">ì „ì†¡</button>
        </div>
    </div>
</div>
<div class="entry">
    <div class="box">
        <input type="text" id="nickname" placeholder="Nickname" autofocus />
        <button type="button" onclick="entry();">ì…ì¥</button>
    </div>
</div>

<script>
  const chat = document.querySelector("#chatContent");
  // const enter = document.querySelector("#enter");
  const urChat = document.querySelector('.ur-chat');
  // const urName = urChat.before;
  // // ëŒ€í™” ìƒëŒ€ ì´ë¦„ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  // function getUserName () {
  //   return 'asd'
  // }
  // // ëŒ€í™” ìƒëŒ€ ì´ë¦„ ì„¤ì •
  // urName.style.content = getUserName();
  //
  // ë©”ì‹œì§€ ì „ì†¡ì‹œ í™”ë©´ ì¶œë ¥
  const addMessage = (e) => {
    if (e.keyCode === 13 || e.type === "click") {
      if (!type.value) {
        alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
        return;
      } else {
        // io ìˆ˜ì‹  socket.on send
        const type = document.querySelector("#type");
        const div = document.createElement("div");
        const span = document.createElement("span");
        div.classList.add("my-chat-wrap");
        span.textContent = type.value;
        span.classList.add("chat-box");
        span.classList.add("my-chat");
        div.appendChild(span);
        chat.appendChild(div);
        type.value = "";
        setTimeout(() => {
          chat.scrollTop = chat.scrollHeight;
        }, 0)
      }
    }

  };
  const type = document.querySelector("#type");
  const enter = document.querySelector("#enter");
  enter.addEventListener("click", addMessage);
  type.addEventListener("keydown", addMessage);
  //


</script>

<script>

  // ë§í’ì„  í˜¸ë²„í•   ë•Œ ë°˜ì‘ íŒì—… on/off
  const msg = document.querySelectorAll(".message");
  console.log('msg', msg)
  const chatWrap = document.querySelectorAll(".chat-wrap");
  msg.forEach((item) => {
    // console.log(item);
    item.addEventListener("mouseenter", function (e) {
      // console.log(this);
      e.stopPropagation();
      const btnBar = this.parentNode.querySelector(".button-bar");
      // console.log(btnBar)
      // const btnBar = this.querySelector(".button-bar");
      btnBar.classList.replace("off", "on");
    });
  });
  chatWrap.forEach((item) => {
    item.addEventListener("mouseleave", function (e) {
      e.stopPropagation();
      const btnBar = this.querySelector(".button-bar");
      btnBar.classList.replace("on", "off");
    });
  });
</script>
<script>
  //e.target ** í´ë¦­ã…
  // socket io ì—°ê²°
  let socket = io.connect();
  let myNick;

  socket.on('connect', () => {
    console.log('chat.ejs Connected =.', socket.id)
  })
  socket.on('notice',(msg)=>{
    document
    .querySelector("#chatContent")
    .insertAdjacentHTML("beforeend", `<div class="notice">${msg}</div>`);
  })
  function entry() {
    console.log(document.querySelector("#nickname").value);
    socket.emit("setNick", document.querySelector("#nickname").value);
  }

  socket.on("entry", (nick) => {
    // 1. ë‚´ ë‹‰ë„¤ì„ ì„¤ì •
    myNick = nick;
document.querySelector('.entry').remove();
    // // 2. ë‹‰ë„¤ì„ ì…ë ¥ì°½ & ë²„íŠ¼ ë¹„í™œì„±í™”
    // document.querySelector("#nickname").disabled = true; // ì…ë ¥ì°½ ë¹„í™œì„±í™” (í´ë¦­ ë§‰ê¸°)
    // document.querySelector(".entry-box > button").disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™” (í´ë¦­ ë§‰ê¸°)
    // // 3. div.chat-box ìš”ì†Œ ë³´ì´ê¸°
    // document.querySelector(".chat-box").classList.remove("d-none");
  });

  // ë¦¬ì•¡ì…˜ ë°˜ì‘
  const quake = document.querySelectorAll('.quake');
  const tada = document.querySelectorAll('.ta-da');
  const reactObj = {
    quake:[ 'animate__animated', 'animate__shakeX' ],
    tada:[ 'animate__animated', 'animate__tada' ],
  }
  quake.forEach((item) => {
    item.addEventListener('click', function (e) {
      const id = e.target.id;
      const reactID = reactObj[id];
      const target = this.parentNode.parentNode.querySelector('.chat-box')
      // íƒœê·¸ì˜ ê³ ìœ ê°’ ë³´ë‚´ê¸°
      target.id = 'id' + Date.now();
      const sid = target.id;
      // console.log(target.id)
      // console.log('this',this)
      // console.log(this.parentNode);
      // console.log('lol',this.parentNode.parentNode.querySelector('.chat-box'));
      const data = {
        reactID:reactID,
        id:sid,
      }
      socket.emit('quake', data);
    })
  })
  // let removeReact;
  socket.on('react', (data) => {
    // console.log(data)
    console.log(data.id)
    console.log(data.first, data.second, data.first)
    const chatBox = document.querySelector('#' + data.id);
    console.log(chatBox)
    // if (removeReact) clearTimeout(removeReact);
    // removeReact = setTimeout(function () {
    //   chatBox.classList.remove(data.second)
    // }, 500)
    // ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    chatBox.classList.add(data.first, data.second);
    // ë°›ì€ ID ì‚­ì œ
    chatBox.removeAttribute('id');
  })
  //   ì±„íŒ…ì°½ ì…ì¥ / í‡´ì¥ ì•ˆë‚´ ë¬¸êµ¬

  // ì±„íŒ…ë°©
  socket.emit('setNick', document.querySelector('#nickname').value)
</script>

</body>
</html>
